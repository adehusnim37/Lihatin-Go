services:
  mariadb:
    image: mariadb:11.4
    container_name: lihatin-mariadb
    restart: unless-stopped
    env_file:
      - .env
    command:
      - --defaults-file=/etc/mysql/my.cnf
    ports:
      - "${DB_BIND_IP:-127.0.0.1}:3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./mariadb/my.cnf:/etc/mysql/my.cnf:ro
      - ./mariadb/conf.d:/etc/mysql/conf.d:ro
      - ./backups/mariadb:/backups
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MARIADB_USER -p$$MARIADB_PASSWORD --silent"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 40s
    mem_limit: 1300m
    cpus: 1.5
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

  valkey:
    image: valkey/valkey:8.1-alpine
    container_name: lihatin-valkey
    restart: unless-stopped
    env_file:
      - .env
    command: ["sh", "-c", "valkey-server /usr/local/etc/valkey/valkey.conf --requirepass $$REDIS_PASSWORD"]
    ports:
      - "${DB_BIND_IP:-127.0.0.1}:6379:6379"
    volumes:
      - valkey_data:/data
      - ./valkey/valkey.conf:/usr/local/etc/valkey/valkey.conf:ro
      - ./backups/valkey:/backups
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli -a $$REDIS_PASSWORD PING | grep -q PONG"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 20s
    mem_limit: 320m
    cpus: 0.5
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  mariadb_data:
  valkey_data:
